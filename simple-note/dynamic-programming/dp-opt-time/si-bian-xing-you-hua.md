---
description: 施工中
---

# 四邊形優化

## 概述

四邊形優化是 DP 優化中一個相當複雜的一個章節，主要處理 1D/1D 跟 2D/1D 的某些型態的 DP。如果只想知道怎麼使用的話可以忽略掉證明的部分直接看定理。

其中關於 1D/1D 的 DP 會以決策單調性的角度來說明四邊形優化。

## 1D/1D DP 與 決策單調性

讓我們先來回顧一下前兩章。前兩章的內容是討論兩種不同 1D/1D DP 的一些特別情形的優化。這裡我們先放上那兩個優化的轉移式：

> 單調隊列優化：$$dp(i)=h(i)+\max\limits_{l(i)\leq j\leq r(i)}\{A(j)\}$$

> 斜率優化：$$dp(i)=h(i)+\max\limits_{j\leq r(i)}\{A(j)X(i)+B(j)\}$$\(這章節考慮$$A,B$$為遞增函數，也就是斜率、查詢都遞增\)

這兩種優化都是基於決策單調性來將複雜度優化到$$O(N)$$。那麼你可能會好奇，還有什麼情況是可以使用決策單調性的呢？接下來我們給出一個更推廣的原理：**四邊形不等式與決策單調性**

### 決策單調性適用原理：四邊形不等式與決策單調性

這裡先再次放上 1D/1D DP 的標準轉移式

$$dp(i)=\max(min)\{dp(j)+w(i,j)\}$$

**四邊形不等式：若**$$w(i,j)$$**滿足四邊形不等式，那麼對於任意**$$a\leq b\leq c\leq d$$，**皆有**$$w(a,c)+w(b,d)\leq (\geq)\ w(a,d)+w(b,c)$$

要注意的是，這裡的四邊形不等式並非代數上的不等式。他只是$$w$$這個函數所具備的特別性質。

那麼我們會有以下定理：

**定理1：若**$$w(i,j)$$**滿足四邊形不等式，那麼這個 1D/1D DP 具有決策單調性**

不同的 min/max 跟大小於符號適用的 DP 跟單調性是有些許差別的，下面分出四種情形，這四種情形都具備決策單調性：

* 當四邊形不等式不等號為$$\leq$$時，若轉移方程取 min，那麼最優決策點的方向跟$$i$$移動的方向**相同**
* 當四邊形不等式不等號為$$\leq$$時，若轉移方程取 max，那麼最優決策點的方向跟$$i$$移動的方向**相反**
* 當四邊形不等式不等號為$$\geq$$時，若轉移方程取 min，那麼最優決策點的方向跟$$i$$移動的方向**相反**
* 當四邊形不等式不等號為$$\geq$$時，若轉移方程取 max，那麼最優決策點的方向跟$$i$$移動的方向**相同**

容易發現其實這就只是排列組合而已，所以只要搞懂其中一個其他的就可以類推出來了。接下來我們只用第一個 case 來進行證明。

#### 定理1證明

> $$dp_i=\min\{dp_j+w(i,j)\}$$  
> $$w(a,c)+w(b,d)\leq\ w(a,d)+w(b,c)$$
>
> 第一個情形的轉移式和四邊形不等式如上。

> 要證明決策單調性就相當於證明 $$p_i\leq p_{i+1}$$
>
> 令$$p_i,p_{i+1}$$代表$$dp_i,dp_{i+1}$$的最優決策點，那麼我們有：
>
> $$dp_{p_i}+w(i,p_i)\leq dp_j+w(i,j)\  \forall j<i$$ ..... 式 \(1\)$$dp_{p_{i+1}}+w(i+1,p_{i+1})\leq dp_j+w(i+1,j)\  \forall j<i+1$$...... 式\(2\)
>
> 以下分兩種情況討論：
>
> 1. $$p_{i+1}=i$$：因為$$p_i<i$$，所以$$p_i\leq p_{i+1}$$必定成立
> 2. $$p_{i+1}\neq i$$：將 \(1\) 的$$j$$代入$$p_{i+1}$$，\(2\) 的$$j$$代入$$p_i$$可以得到下面兩個式子：  $$dp_{p_i}+w(i,p_i)\leq dp_{p_{i+1}}+w(i,p_{i+1})$$ $$dp_{p_{i+1}}+w(i+1,p_{i+1})\leq dp_{p_i}+w(i+1,p_i)$$  把這兩個式子相加可以得到：  $$w(i,p_i)+w(i+1,p_{i+1})\leq w(i,p_{i+1})+w(i+1,p_i)$$  根據四邊形不等式可以利用反證證出$$p_i\leq p_{i+1}$$，證畢。

那我們有決策單調性可以做什麼呢？我們剛剛提到了，單調隊列優化以及斜率優化都具有決策單調性，而他們確實也符合四邊形不等式。這部分就自己留給讀者證明，接下來這邊給出四邊形優化的一般型式：

### 四邊形不等式一般情形：分治/二分

單調隊列優化跟斜率優化都對$$w(i,j)$$有比較特別的要求。具體來說，要可以把$$i,j$$分離到一定程度。那麼如果$$w$$只滿足四邊形不等式呢？舉例來說：$$w(i,j)=\sqrt{i+j}$$，證明的部分留給讀者。**為了方便下文講解，以下一律考慮決策點單調遞增的情形。**

所以接下來我們要介紹兩個更通用的作法：

### 分治優化

修但幾類，為什麼分治優化會出現在這邊？難不成分治優化也是四邊形優化的一小部分？我們這邊給出我所知道的分治優化的轉移式跟使用時機：

> $$dp(i,j)=\min\limits_{k<j}\{dp(i-1,k)+C(k,j)\}$$
>
> 如果 DP 滿足決策點單調，那麼可以使用分治優化：
>
> **決策點單調：**令$$p(i,j)$$為$$dp(i,j)$$的最優決策點。
>
> 如果$$\forall i,j$$，滿足$$p(i,j)\leq p(i,j+1)$$，則稱之為決策點單調

決策點單調？那不就是我們這章在講的內容嘛！但是我們現在只討論了 1D/1D DP 的決策點單調，那這個要怎麼處理呢？

可以發現一件事情，上面的這個轉移式的$$dp(i,j)$$來源都是從$$dp(i-1,*)$$來的，也就是說如果$$dp(i-1,*)$$已經全部都處理完了，那麼$$dp(i,*)$$其實就可以當成是從一坨跟$$i$$完全沒有關係的東西轉移。那麼我們不妨就可以把上面這個轉移式改寫：

$$dp(j)=\min\limits_{k<j}\{g(k)+C(k,j)\}$$

而分治優化其實就是在把上面這個轉移式做$$N$$次而已。於是我們就把他變成 1D/1D DP 了。而我們又知道，如果$$g(k)+C(k,j)$$滿足四邊形不等式，那麼$$dp(j)$$的決策點單調，那我們就可以在分治優化上面套四邊形優化啦！

















