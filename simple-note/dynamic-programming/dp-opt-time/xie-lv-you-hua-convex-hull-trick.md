# 斜率優化 \(Convex Hull Trick\)

前面的都是比較簡單一點的DP優化，從這裡開始會變得稍微難一點。\(當然，這裡的難是對我來說。\)

## 介紹

斜率優化應該不算太難的 DP 優化，而且出現的頻率也絕對不在少數。

雖然說他的名字叫做斜率優化，但是我個人覺得凸包優化 \(英文名字\) 比較適合他。理由的話我們就繼續看下去吧。

## 概述

### 理論

有一些 1D/1D 的 DP 的轉移式會長成下面這樣：

$$dp(i)=h(i)+\max\limits_{j\leq r(i)}\{a(j)X(i)+b(j)\}$$

其中 $$r(i)<i$$是一個遞增函數、$$X(i)$$和 $$h(i)$$是容易求得的函數，而 $$a(j)$$、$$b(j)$$裡面可能會包含 $$dp(j)$$，也就是 $$j$$是狀態 $$i$$ 的子問題。這樣子的複雜度是 $$O(N^2)$$的，而斜率優化就是在優化這種類型的轉移式。因為 $$h(i)$$是一個容易求得的函數，而真正難算的部分在於後面的 $$max$$，所以下面說明後面那坨東西要怎麼優化。

最一開始有提到，DP 優化大多都是優化轉移的過程，斜率優化也不例外，就是要加速轉移的過程。為了加速轉移的過程，我們可以拋棄掉那些不可能成為轉移來源的狀態不去處理，那要怎麼做呢？

對於每個**已經算出答案的** $$j$$\(也就是說 $$a(j)$$和 $$b(j)$$都已經被算出來了\)，我們畫一條直線 $$y=a(j)x+b(j)$$到平面上。那麼結果可能會長得跟下面這張圖這樣 \(考慮 $$j\in[0,4]$$\)：

\(圖片待補\)

我們會發現所有數字的最大值會形成一個**下凸包**。而如果有線完全落在這個下凸包的下面\(例如 $$j=3$$那條線\)，那麼這條線就永遠不可能會成為我們的轉移來源。換句話說，我們的轉移來源只會出現在那個下凸包上面。假設我們現在要更新 $$dp(i)$$這個狀態，我們的轉移就相當於是在這個下凸包上找到 $$X(i)$$這個點是落在下凸包哪一條線段上。把 $$X(i)$$帶入那個線段所得到的值就會是我們的 $$dp(i)$$。

所以說我們現在把題目變成要做兩件事：

1. 動態維護下凸包
2. 快速找到 $$X(i)$$這個點是落在哪一個線段上

### 動態維護凸包

我們現在要維護一個支持**插入操作**的凸包。如果你們上網去查的話會發現真的有動態凸包這個東西。但是身為一個佛系競程玩家，我不願意學那種又長又不好寫常數又大的東西。所以我們這邊要引入一個神奇的資料結構：李超線段樹

### 李超線段樹

這個東西其實應該被放在資料結構裡面，但是因為 iceylemon 很懶，所以他把決定先寫在這邊。

我們用一個問題來引入李超線段樹這個東西：

> 現在要進行若干次操作，每一次操作會是下列兩種中的一種：
>
> * 插入一條直線
> * 詢問一條直線 $$x=t$$與其他直線相交的點中，最大的 $$y$$ 座標

沒錯，這就是一個動態凸包問題 \(就是我們要解決的問題\)。而李超線段樹就是一個用來解決這類問題的**線段樹變形**。

李超線段樹的理念如下：對**值域**

